
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Non-determinism Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../up-and-running/" />
    
    
    <link rel="prev" href="duplication.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../intro/">
            
                <a href="../intro/">
            
                    
                    Introduction
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../intro/what-is-npm.html">
            
                <a href="../intro/what-is-npm.html">
            
                    
                    What is npm?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../intro/app-design.html">
            
                <a href="../intro/app-design.html">
            
                    
                    Modularity and Application Design
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../intro/packages-and-modules.html">
            
                <a href="../intro/packages-and-modules.html">
            
                    
                    Packages and Modules
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.4" data-path="../intro/dependency-hell.html">
            
                <a href="../intro/dependency-hell.html">
            
                    
                    Package Managers and Dependency Hell
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.5" data-path="../intro/history.html">
            
                <a href="../intro/history.html">
            
                    
                    The Node Module Loader and npm2
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="./">
            
                <a href="./">
            
                    
                    Hello, npm!
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="dependency-resolution.html">
            
                <a href="dependency-resolution.html">
            
                    
                    Dependency Resolution
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="duplication.html">
            
                <a href="duplication.html">
            
                    
                    Duplication and Deduping
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.3.3" data-path="non-determinism.html">
            
                <a href="non-determinism.html">
            
                    
                    Non-determinism
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../up-and-running/">
            
                <a href="../up-and-running/">
            
                    
                    Up and Running
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../up-and-running/installation.html">
            
                <a href="../up-and-running/installation.html">
            
                    
                    Installing Node.js and npm
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../up-and-running/exercise1.html">
            
                <a href="../up-and-running/exercise1.html">
            
                    
                    Exercise 1: Changing versions of npm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../using-packages/">
            
                <a href="../using-packages/">
            
                    
                    Using Packages
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../using-packages/registry.html">
            
                <a href="../using-packages/registry.html">
            
                    
                    The Registry
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../using-packages/installing.html">
            
                <a href="../using-packages/installing.html">
            
                    
                    Installing Packages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../using-packages/node.html">
            
                <a href="../using-packages/node.html">
            
                    
                    Using npm Packages with Node.js
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../using-packages/exercise2.html">
            
                <a href="../using-packages/exercise2.html">
            
                    
                    Exercise 2: Installing and Using Packages in Node.js
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="../using-packages/exercise3.html">
            
                <a href="../using-packages/exercise3.html">
            
                    
                    Exercise 3: Debugging Missing Packages
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="../using-packages/packagejson.html">
            
                <a href="../using-packages/packagejson.html">
            
                    
                    Using a package.json
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="../using-packages/exercise4.html">
            
                <a href="../using-packages/exercise4.html">
            
                    
                    Exercise 4: A Static Site, with npm
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../semver/">
            
                <a href="../semver/">
            
                    
                    Semantic Versioning (Semver)
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../semver/ranges.html">
            
                <a href="../semver/ranges.html">
            
                    
                    Version Ranges
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../semver/exercise5.html">
            
                <a href="../semver/exercise5.html">
            
                    
                    Exercise 5: Specifying Version Ranges in package.json
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../semver/majorminorpatch.html">
            
                <a href="../semver/majorminorpatch.html">
            
                    
                    Major.Minor.Patch
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.4" data-path="../semver/exercise6.html">
            
                <a href="../semver/exercise6.html">
            
                    
                    Exercise 6: Release Manager Role Playing
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../publishing/">
            
                <a href="../publishing/">
            
                    
                    Publishing a Package
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../publishing/publishing.html">
            
                <a href="../publishing/publishing.html">
            
                    
                    Publishing Workflow
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../publishing/exercise7.html">
            
                <a href="../publishing/exercise7.html">
            
                    
                    Exercise 7: Our First Package!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../publishing/teams-orgs.html">
            
                <a href="../publishing/teams-orgs.html">
            
                    
                    Private Packages, Teams, and Orgs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="../run-scripts/">
            
                <a href="../run-scripts/">
            
                    
                    Run Scripts
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../run-scripts/intro.html">
            
                <a href="../run-scripts/intro.html">
            
                    
                    What are run scripts?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../run-scripts/start-and-test.html">
            
                <a href="../run-scripts/start-and-test.html">
            
                    
                    start and test
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../run-scripts/exercise8.html">
            
                <a href="../run-scripts/exercise8.html">
            
                    
                    Exercise 8: Writing a start script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../run-scripts/custom.html">
            
                <a href="../run-scripts/custom.html">
            
                    
                    Custom Run Scripts
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../run-scripts/exercise9.html">
            
                <a href="../run-scripts/exercise9.html">
            
                    
                    Exercise 9: Writing a custom build script
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="../run-scripts/lifecycle-events.html">
            
                <a href="../run-scripts/lifecycle-events.html">
            
                    
                    Lifecycle Events
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="../run-scripts/exercise10.html">
            
                <a href="../run-scripts/exercise10.html">
            
                    
                    Exercise 10: Writing a prepublish script
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../conclusion/">
            
                <a href="../conclusion/">
            
                    
                    Conclusion
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../conclusion/summary.html">
            
                <a href="../conclusion/summary.html">
            
                    
                    Summary
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../conclusion/next-steps.html">
            
                <a href="../conclusion/next-steps.html">
            
                    
                    Next Steps
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Non-determinism</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="non-determinism">Non-determinism</h1>
<p>As stated a few pages back in our example:</p>
<p><img src="images/install-order.png" alt="install order"></p>
<p>If you, and your development team, use a <code>package.json</code>, as well
as the interactive <code>npm install</code> command to add pkgs (like most
teams using npm do), it is likely that you will run into a situation
where your local <code>node_modules</code> directory will differ from both
your coworkers&apos; <code>node_modules</code> directories, as well as the <code>node_modules</code>
directories on your staging, testing, or production servers.</p>
<p>In short? <strong>npm3 does not install dependencies in a deterministic way.</strong></p>
<p>That&apos;s probably not a comforting statement to read, but in this article
we&apos;ll discuss why this happens, as well as assure you that it has no
implications for your application, as well as explain the steps to
reliably (re)create a single, consistent, <code>node_modules</code> directory, should
you want to do that.</p>
<h2 id="example">Example</h2>
<p>Let&apos;s jump back to an example application from a few examples ago:</p>
<p><img src="images/npm3deps8.png" alt="app"></p>
<p>In this example, our app has the following <code>package.json</code>:</p>
<pre><code>{
  &quot;name&quot;: &quot;example3&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;keywords&quot;: [],
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;mod-a&quot;: &quot;^1.0.0&quot;,
    &quot;mod-c&quot;: &quot;^1.0.0&quot;,
    &quot;mod-d&quot;: &quot;^1.0.0&quot;,
    &quot;mod-e&quot;: &quot;^1.0.0&quot;
  }
}
</code></pre><p>On an <code>npm install</code> we will see this in our terminal:</p>
<p><img src="images/npm3deps14.png" alt="npm install"></p>
<p>Now, let&apos;s say a developer on our team decides to complete a feature that
requires that they update Module A to v2.0, which now has a dependency on
Module B v2.0, instead of, as previously, Module B v1.0.</p>
<p><img src="images/npm3deps9.png" alt="module a v2"></p>
<p>Our developer uses the interactive <code>npm install</code> command to install the new
version of Module A, and save it to the <code>package.json</code>:</p>
<pre><code>npm install mod-a@2 --save
</code></pre><p>The terminal outputs this:</p>
<p><img src="images/npm3deps15.png" alt="interactive install mod a"></p>
<p>We now have something that looks like this:</p>
<p><img src="images/npm3deps10.png" alt="tree with mod a v2 interactive"></p>
<p>Now let&apos;s say that our developer finished the feature requiring the new 
version of Module A and pushes the application to a testing server
that runs <code>npm install</code> on the new <code>package.json</code>:</p>
<pre><code>{
  &quot;name&quot;: &quot;example3&quot;,
  &quot;version&quot;: &quot;1.0.0&quot;,
  &quot;description&quot;: &quot;&quot;,
  &quot;main&quot;: &quot;index.js&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
  },
  &quot;keywords&quot;: [],
  &quot;author&quot;: &quot;&quot;,
  &quot;license&quot;: &quot;ISC&quot;,
  &quot;dependencies&quot;: {
    &quot;mod-a&quot;: &quot;^2.0.0&quot;,
    &quot;mod-c&quot;: &quot;^1.0.0&quot;,
    &quot;mod-d&quot;: &quot;^1.0.0&quot;,
    &quot;mod-e&quot;: &quot;^1.0.0&quot;
  }
}
</code></pre><p>The testing server&apos;s log shows this:</p>
<p><img src="images/npm3deps16.png" alt="tree with mod a v2 packagejson"></p>
<p>Which, when visualized, looks like this:</p>
<p><img src="images/npm3deps17.png" alt="totally diff dep tree"></p>
<p>Whoa, what?! This tree is completely different than the tree that
exists on our developer&apos;s local machine. What happened?</p>
<p><strong>Remember: install order matters.</strong></p>
<p>When our developer updated Module A using the interactive <code>npm install</code>
Module A v2.0 was functionally the <strong>last</strong> package installed. Because
our developer had done an <code>npm install</code> when they first started working
on the project, all modules listed in the <code>package.json</code> were already
installed in the <code>node_modules</code> folder. <strong>Then</strong> Module A v2.0 was 
installed.</p>
<p>It follows, then, that Module Bv1.0, a top level dependency because of
Module A v1.0, then anchored by Module E v1.0, remains a top level
dependency. Because Module Bv1.0 occupies the top-level, no other version
of Module B can-- therefore, Module Bv2.0 remains a nested dependency
under Module C v1.0 and Module D v1.0, and becomes a nested dependency
for the new Module A v2.0 dependency.</p>
<p>Let&apos;s consider what happened on the testing server. The project was pulled
into a fresh directory, i.e. does not have a pre-existing <code>node_modules</code>
directory. Then <code>npm install</code> is run, perhaps by a deploy script, to install
dependencies from the <code>package.json</code>.</p>
<p>This <code>package.json</code> now has Module A v2.0 listed in it, and thanks to
alphabetical order (enforced by the <code>npm install</code> command), is now installed
<strong>first</strong>, instead of <strong>last</strong>.</p>
<p>When Module A v2.0 is installed first, in a clear <code>node_modules</code> directory, its
dependencies are the <strong>first candidates</strong> for the top-level position. As a result,
Module B v2.0 is installed in the top-level of the <code>node_modules</code> directory.</p>
<p>Now, when it is time to install Module E v1.0, its dependency, Module B v1.0,
cannot occupy the top-level of the <code>node_modules</code> directory, because Module B v2.0
is already there. Therefore, it is nested under Module E v1.0.</p>
<h2 id="do-different-dependency-tree-structures-affect-my-app">Do different dependency tree structures affect my app?</h2>
<p>No! Even though the trees are different, both sufficiently install and point
all your dependencies at all their dependencies, and so on, down the tree.
You still have everything you need, it just happens to be in a different
configuration.</p>
<h2 id="i-want-my-nodemodules-directory-to-be-the-same-how-can-i-do-that">I want my <code>node_modules</code> directory to be the same. How can I do that?</h2>
<p>The <code>npm install</code> command, when used exclusively to install packages from a
<code>package.json</code>, will <strong>always produce the same tree</strong>. This is because install order
from a <code>package.json</code> is <strong>always</strong> alphabetical. Same install order means that
you will get the same tree.</p>
<p>You can reliably get the same dependency tree by removing your <code>node_modules</code>
directory and running <code>npm install</code> whenever you make a change to your <code>package.json</code>.</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="duplication.html" class="navigation navigation-prev " aria-label="Previous page: Duplication and Deduping">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../up-and-running/" class="navigation navigation-next " aria-label="Next page: Up and Running">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Non-determinism","level":"1.3.3","depth":2,"next":{"title":"Up and Running","level":"1.4","depth":1,"path":"up-and-running/README.md","ref":"up-and-running/README.md","articles":[{"title":"Installing Node.js and npm","level":"1.4.1","depth":2,"path":"up-and-running/installation.md","ref":"up-and-running/installation.md","articles":[]},{"title":"Exercise 1: Changing versions of npm","level":"1.4.2","depth":2,"path":"up-and-running/exercise1.md","ref":"up-and-running/exercise1.md","articles":[]}]},"previous":{"title":"Duplication and Deduping","level":"1.3.2","depth":2,"path":"npm3/duplication.md","ref":"npm3/duplication.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"INTRO.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"npm3/non-determinism.md","mtime":"2016-10-11T18:12:55.538Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2016-10-11T18:13:51.490Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

